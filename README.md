# Raid Bot

Discord-бот для организации рейдовых событий: создание мероприятий, распределение ролей и отслеживание записей участников. Проект написан на Python и использует slash-команды Discord.

## Возможности

- Создание, редактирование, удаление и просмотр рейдов.
- Гибкое распределение ролей (tank/healer/dps и т.д.) с ограничением слотов.
- Встроенные UI-компоненты Discord для записи и выхода из рейда.
- Хранение данных в SQLite с автоматическим созданием схемы.
- Покрытие ключевой логики автоматическими тестами (`pytest`).
- Очередь резерва с автоматическим повышением при освобождении мест.
- Автоматические напоминания о старте рейда с настраиваемыми интервалами (по умолчанию 60/15/5 минут).
- Шаблоны и клонирование рейдов для быстрого повторного использования настроек.
- Расписания с автосозданием повторяющихся рейдов.

## Требования

- Python 3.10+
- Discord бот-токен
- SQLite (входит в стандартную библиотеку Python)

## Установка

```bash
python -m venv .venv
source .venv/bin/activate
pip install -U pip
pip install -r requirements.txt  # файл будет добавлен после декомпозиции
```

> Пока зависимости не вынесены в `requirements.txt`. См. раздел «Планы развития».

Создайте файл `.env` с токеном Discord:

```env
DISCORD_TOKEN=your-bot-token
# необязательно: переопределить путь к базе данных
RAIDBOT_DB=raids.db
```

Для локального тестирования вместо `.env` можно положить токен в `token.txt` — бот считает его автоматически.

## Запуск

```bash
python main.py
```

Бот создаст базу данных SQLite и зарегистрирует slash-команды в Discord-гильдии. Убедитесь, что приложение Discord имеет права на `applications.commands` и `bot`.

## Шаблоны и клонирование

- `/raid clone` — копирует существующее событие с новыми датой/названием.
- `/raid template create` — сохраняет набор ролей и параметров как шаблон (для текущей гильдии).
- `/raid template list` — показывает сохранённые шаблоны.
- `/raid template use` — создаёт новое событие на основе выбранного шаблона.

## Расписания повторяющихся рейдов

- `/raid schedule create` — создаёт расписание на основе шаблона. Можно указать день недели, время, период повторения, канал публикации и собственные напоминания. Название поддерживает плейсхолдеры `strftime`, например `Авалон %d.%m`.
- `/raid schedule list` — выводит активные расписания для гильдии с датой следующего рейда и настройками напоминаний.
- `/raid schedule delete` — удаляет расписание (уже созданные события остаются).

Расписание автоматически создаёт новое событие, когда до старта остаётся меньше заданного порога (по умолчанию период повторения минус один час). Все даты отображаются в формате `HH:MM DD.MM.YY`.

Резервные записи отображаются в отдельном блоке «Резерв» внутри embed, а при освобождении слотов бот автоматически продвигает пользователей из очереди и присылает уведомление в канал.

## Тестирование

Вместо устаревшей самопроверки используется `pytest`.

```bash
python -m pytest
```

Тесты покрывают парсинг ролей, конвертацию времени и ключевые сценарии записи на рейд с проверкой ограничений.

## Планы развития

- [x] Разбить монолитный `main.py` на модули (см. `docs/tasks/split-into-modules.md`).
- [ ] Вынести зависимости в `requirements.txt` и добавить инструкции по установке.
- [x] Настроить автоматические тесты вместо `_selftest`.
- [ ] Добавить GitHub Actions для линтинга и тестирования.

## Структура репозитория

```
.
├── commands.py
├── config.py
├── db.py
├── docs/
│   └── tasks/
│       └── split-into-modules.md
├── main.py
├── models.py
├── tests/
│   └── test_utils.py
├── utils.py
└── views.py
```

## Лицензия

Лицензия пока не выбрана. Принимаются предложения.
