# Raid Bot

Discord-бот для планирования рейдов в гильдии Albion Online. Он позволяет создавать события со строгими квотами по ролям, собирать заявки участников и автоматически управлять резервом и напоминаниями.

## Ключевые возможности

- Slash-команды для полного жизненного цикла рейдов: создание, редактирование, клонирование, удаление, просмотр и вывод списка ближайших событий.
- Гибкие квоты по ролям с автоматической проверкой ограничений и переносом лишних заявок в резерв.
- Поддержка шаблонов рейдов и расписаний для автогенерации повторяющихся событий.
- Очередь ожидания с автоматическим повышением участников в основной состав и уведомлением в канал.
- Встроенная система напоминаний с настройкой интервалов для каждого рейда.
- UI-компоненты Discord (`Select` и `Button`) для записи и снятия заявки без ввода команд.
- Учёт посещаемости рейдов с историей ролей и агрегированной статистикой по игрокам.

## Требования

- Python 3.10 или новее.
- Discord-бот с правами `applications.commands` и `bot`.
- Библиотека [discord.py](https://discordpy.readthedocs.io/) 2.0+.
- (Опционально) [python-dotenv](https://pypi.org/project/python-dotenv/) для загрузки переменных из `.env`.

## Установка

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install -U pip
pip install -r requirements.txt
```

## Конфигурация

Бот считывает конфигурацию из переменных окружения или файла `.env`:

```env
DISCORD_TOKEN=your-bot-token
RAIDBOT_DB=raids.db  # опционально: путь к SQLite-базе
```

Если переменная `DISCORD_TOKEN` не задана, бот попытается прочитать токен из `token.txt` в корне репозитория.

## Запуск

```bash
python main.py
```

При первом запуске бот создаст файл базы данных SQLite и зарегистрирует slash-команды в выбранной гильдии.

## Команды

| Команда | Назначение |
| --- | --- |
| `/raid create` | Создать рейд с квотами по ролям и напоминаниями. |
| `/raid edit` | Изменить параметры события, роли и напоминания. |
| `/raid delete` | Удалить событие и очистить напоминания. |
| `/raid clone` | Создать копию существующего рейда с новыми параметрами. |
| `/raid view` | Показать текущее состояние рейда (состав и резерв). |
| `/raid list` | Вывести ближайшие события. |
| `/raid stats` | Показать суммарную статистику и историю посещаемости. |
| `/raid template create` | Создать или обновить шаблон рейда. |
| `/raid template list` | Показать шаблоны гильдии. |
| `/raid template delete` | Удалить шаблон. |
| `/raid template use` | Создать рейд на основе шаблона. |
| `/raid schedule create` | Создать расписание автогенерации рейдов. |
| `/raid schedule list` | Показать активные расписания. |
| `/raid schedule delete` | Удалить расписание (созданные рейды сохраняются). |

## UI и обработка заявок

Каждое событие сопровождается `SignupView`, содержащим:

- селектор ролей — участник выбирает слот и мгновенно записывается;
- кнопку «Снять запись» для выхода из события.

При достижении лимита рейда заявки отправляются в резерв, а при освобождении мест бот автоматически продвигает ожидание и уведомляет канал.

## Посещаемость и статистика

- Все изменения состава фиксируются в базе, поэтому `/raid stats` показывает актуальную сводку по ролям и рейдам.
- Укажите параметр `member`, чтобы увидеть историю конкретного игрока со статусами «основной состав», «резерв» и «удалён».
- История посещаемости хранится даже после удаления рейда и пригодится для долгосрочной аналитики.

## Расписания и напоминания

- События по расписанию публикуются заранее — за указанное количество часов до старта.
- Время старта и название события могут содержать плейсхолдеры `strftime`, например `"Авалон %d.%m"`.
- Напоминания можно задавать в минутах, часах или днях (`120`, `30m`, `2h`, `1d`). Если интервалы не указаны, применяются значения по умолчанию `1ч / 15м / 5м`.

## Структура проекта

Архитектура подробно описана в [`docs/architecture.md`](docs/architecture.md). Кратко:

```
.
├── commands.py      # slash-команды и бизнес-потоки
├── config.py        # загрузка конфигурации и логирование
├── db.py            # слой доступа к SQLite и фоновые операции
├── docs/            # документация проекта
├── models.py        # датаклассы доменных сущностей
├── scheduler.py     # сервис напоминаний и генерация расписаний
├── utils.py         # утилиты (парсинг, сборка сообщений, права)
├── views.py         # Discord UI для записи/отписки
└── tests/           # автотесты (pytest)
```

## Тестирование

Проект покрыт pytest-тестами для ключевых сценариев: парсинг входных данных, логика записи и резерва, управление напоминаниями и генерацией расписаний.

```bash
python -m pytest
```

Подробнее о тестах и сценариях см. в [`docs/testing.md`](docs/testing.md).

## Линтеры

Кодовая база использует `ruff` и `black` (см. [`pyproject.toml`](pyproject.toml)). Запустить проверки можно командами:

```bash
ruff check .
black --check .
```

Для автоматического форматирования выполните `black .`, а `ruff` поможет поймать ошибки стиля и типовые баги до ревью.

## Планы развития

- [x] Вынести зависимости в `requirements.txt`.
- [ ] Настроить CI (линтеры + pytest).
- [ ] Добавить web-панель для просмотра статистики.

