# Архитектура Raid Bot

Документ описывает ключевые компоненты бота и их взаимодействие.

## Обзор модулей

| Модуль | Ответственность |
| --- | --- |
| `config.py` | Загрузка конфигурации из окружения/`.env`, базовые константы и логгер. |
| `models.py` | Датаклассы, представляющие рейды, шаблоны, расписания, напоминания и заявки. |
| `db.py` | Работа с SQLite: инициализация схемы, CRUD-операции, управление резервом, напоминаниями и лог посещаемости. |
| `utils.py` | Бизнес-утилиты: парсинг ролей/дат, форматирование, проверки прав, сборка embed. |
| `views.py` | Discord UI (`SignupView`, селектор ролей, кнопка снятия записи) и обработчики заявок. |
| `commands.py` | Slash-команды `/raid`, `/raid template`, `/raid schedule` и вспомогательные сценарии. |
| `scheduler.py` | Фоновый `ReminderService` и генерация рейдов по расписаниям. |
| `main.py` | Точка входа: создание `discord.Bot`, регистрация команд, запуск сервиса напоминаний. |

## Потоки данных

### Создание рейда

1. Команда `/raid create` парсит аргументы (`utils.parse_roles`, `utils.parse_reminder_offsets`).
2. `db.create_raid` записывает событие в БД, а `db.reset_raid_reminders` инициализирует напоминания.
3. `utils.make_embed` формирует сообщение, `views.SignupView` предоставляет UI для заявок.

### Заявка и резерв

1. UI вызывает `views.handle_signup`, который валидирует роль и лимиты.
2. При переполнении слота заявка помещается в `raid_waitlist`.
3. При освобождении мест `db.promote_waitlist` поднимает участников и `views.announce_promotions` отправляет уведомление.

### Посещаемость

1. Любое изменение состава (`add_signup`, `add_waitlist_entry`, снятие записи) вызывает `db.record_attendance`, который пишет событие в `raid_attendance_log`.
2. Запрос `/raid stats` использует `db.get_attendance_summary` и `db.get_attendance_history`, чтобы показать агрегированные данные и историю игрока.
3. Лог хранит последний статус игрока по рейду, поэтому статистика корректно отражает переносы между резервом и основным составом.

### Редактирование рейда

1. `/raid edit` обновляет поля события и роли, используя `db.update_raid`, `db.replace_roles` и `db.enforce_signup_limits`.
2. После изменений `views.sync_roster` обновляет сообщение, чтобы показать актуальный состав и резерв.

### Шаблоны и расписания

- Шаблоны (`raid_templates`) сохраняют типовые настройки событий.
- Расписания (`raid_schedules`) ссылаются на шаблон и определяют день/время запуска и окно публикации.
- `scheduler.maybe_generate_schedule_event` создаёт рейд, когда наступает время публикации, и планирует следующую дату.

### Напоминания

1. `db.reset_raid_reminders` формирует записи в `raid_reminders` на основе стартового времени и интервалов.
2. `scheduler.ReminderService` периодически вызывает `_tick`, выбирает напоминания (`db.list_due_reminders`) и отправляет сообщения в канал.
3. После отправки `db.mark_reminder_sent` помечает напоминание выполненным.

## Точки расширения

- Добавление новых типов напоминаний/уведомлений возможно через расширение `scheduler.ReminderService`.
- Для интеграции с внешними системами можно использовать слой `db.py` как единый источник состояния.
- Дополнительные slash-команды удобно размещать рядом в `commands.py`, используя общие утилиты и UI.

